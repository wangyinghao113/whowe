<!DOCTYPE html>
<html>
<head lang="en">
    <meta charset="UTF-8">
    <meta name="viewport" id="viewport" content="width=device-width, initial-scale=1">
    <title></title>
    <style>
        *{
            margin:0;
            padding:0;
        }
        ul{
            margin:20px auto;
            position:relative;
        }
        ul li{
            width:160px;
            padding:10px;
            position:absolute;
            box-shadow:10px 5px 15px #ddd;
            list-style:none;
            opacity:0;
            -moz-opacity:0;
            filter:alpha(opacity=0);
            -webkit-transition:opacity 500ms ease-in-out;
            -moz-transition:opacity 500ms ease-in-out;
            -o-transition:opaicty 500ms ease-in-out;
            transition:opaicty 500ms ease-in-out;
        }
        ul li img{
            width:100%;
            height:100%;
            object-fit:cover;
        }
        ul li p{
            width:100%;
            text-align:center;
            font-size:14px;
            color:#333;
            line-height:18px;
            margin-top:10px;
        }
        .loadwrap{position:absolute; left:0; width:100%; text-align:center;}
    </style>

</head>
<body>
<div class="main">
    <ul>
        <li><img  src="1.jpg"><p>啦啦啦啦啦</p></li>
        <li><img  src="2.jpg"><p>啦啦啦啦啦</p></li>
        <li><img  src="3.jpg"><p>啦啦啦啦啦</p></li>
        <li><img  src="4.jpg"><p>啦啦啦啦啦</p></li>
        <li><img  src="5.jpg"><p>啦啦啦啦啦</p></li>
        <li><img  src="6.jpg"><p>啦啦啦啦啦</p></li>
        <li><img  src="7.jpg"><p>啦啦啦啦啦</p></li>
        <li><img  src="8.jpg"><p>啦啦啦啦啦</p></li>
        <li><img  src="9.jpg"><p>啦啦啦啦啦</p></li>
        <li><img  src="3.jpg"><p>啦啦啦啦啦</p></li>
        <li><img  src="5.jpg"><p>啦啦啦啦啦</p></li>
        <li><img  src="1.jpg"><p>啦啦啦啦啦</p></li>

    </ul>
    <div id="loadimg" class="loadwrap">加载...</div>
</div>
    <script typet="text/javascript" src="http://libs.baidu.com/jquery/1.9.1/jquery.min.js"></script>
    <script>
        $(function(){
            window.onload = function(){
                flow(10,10);
            }
        });

        function flow(mh,mv) {  //参数mh和mv是定义数据块之间的间距，mh是水平距离，mv是垂直距离
            var w = $(window).width();  //获取页面的宽度
            var ul = $("ul");
            var li = $("ul li");
            var liw = li.eq(0).outerWidth()+mh; //计算数据块的宽度
            var c = Math.floor(w / liw);  //计算列数
            ul.width(liw * c - mh + "px");  //设置ul的宽度至适合便可以利用css定义的margin把所有内容居中

            var lilength = li.length;
            var lenArr = [];
            for(var i=0;i<lilength;i++){  //遍历每一个数据块将高度记入数组
                lenArr.push(li.eq(i).outerHeight());
            }

            var oArr = [];
            for(var i=0;i<c;i++){  //把第一行排放好，并将每一列的高度记入数据oArr
                li.eq(i).css({top:0,left:liw*i+"px",opacity:1});
                oArr.push(lenArr[i]);
            }

            for(var i=c;i<lilength;i++){  //将其他数据块定位到最短的一列后面，然后再更新该列的高度
                var x = _getMinKey(oArr);  //获取最短的一列的索引值
                li.eq(i).css({top:oArr[x]+mv+"px",left:liw*x+"px",opacity:1});
                oArr[x]=lenArr[i]+oArr[x]+mv; //更新该列的高度
            }
            $("#loadimg").css({top: _getMaxValue(oArr) + 50 + "px"});  //将loading移到下面
            function scroll(){
                var st = oArr[_getMinKey(oArr)];
                var scrollTop = document.documentElement.scrollTop > document.body.scrollTop? document.documentElement.scrollTop : document.body.scrollTop;
                if (scrollTop >= st - document.documentElement.clientHeight) {
                    window.onscroll = null;//为防止重复执行，先清除事件
                    $.ajax({  //当滚动到达最短的一列的距离时便发送ajax请求新的数据，然后执行回调函数
                        url:"json.json",
                        type:"post",
                        success:function(data){
                            var data = data.json;
                            addItem(data,function(){
                                var liLenNew = $("li").length;
                                for(var i = lilength; i < liLenNew; i++) {
                                    lenArr.push($("li").eq(i).outerHeight());
                                }
                                for(var i = lilength; i < liLenNew; i++) {
                                    var x = _getMinKey(oArr);  //获取最短的一列的索引值
                                    $("li").eq(i).css({top:oArr[x]+mv+"px",left:liw*x+"px",opacity:1});
                                    oArr[x]=lenArr[i]+oArr[x]+mv; //更新该列的高度
                                    console.log(lenArr[i]);
                                    console.log(oArr[x]);
                                }
                                document.getElementById("loadimg").style.top = _getMaxValue(oArr) + 50 + "px";//loading向下移位
                                lilength = liLenNew;
                                window.onscroll = scroll;//执行完成，恢愎onscroll事件
                            })
                        },
                        error:function(err){
                            console.log(err);
                        }
                    })
                }
            }
            window.onscroll = scroll();
        }
        function addItem(arr,callback){
            var str = '';
            var a = 0;
            var len = arr.length;
            (function loading(){
                var img = new Image();
                img.onload = function() {
                    a += 1;
                    if (a == len) {
                        for (var k in arr) {
                            var img = new Image();
                            img.src = arr[k].img;
                            str += '<li><img src="' + arr[k].img + '" /><p>' + arr[k].title + '</p></li>';
                        }
                        $("ul").append(str);
                        callback();
                    }
                    else {
                        loading();
                    }
                }
                img.src = arr[a].img;
            })()
        }
        //改变窗口大小时重新布局
        var re;
        window.onresize = function() {
            clearTimeout(re);
            re = setTimeout(function() {flow(10, 10);}, 200);
        }
        //获取数字数组的最大值
        function _getMaxValue(arr) {
            var a=arr[0];
            for(var k in arr){
                if(arr[k] > a){
                    a=arr[k];
                }
            }
            return a;
        }
        //获取数字数组最小值的索引
        function _getMinKey(arr) {
            var a = arr[0];
            var b = 0;
            for (var k in arr) {
                if (arr[k] < a) {
                    a = arr[k];
                    b = k;
                }
            }
            return b;
        }
    </script>
</body>
</html>
